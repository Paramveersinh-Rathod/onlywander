<% layout("/layouts/boilerplate") %>

<style>
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .host-form-container {
        background-color: #ffffff;
        padding: 2.5rem 3rem;
        border-radius: 1rem;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.07);
        animation: fadeInUp 0.6s ease-out forwards;
    }

    .form-header h2 {
        font-weight: 700;
        color: #222;
    }

    .form-header p {
        color: #6c757d;
    }

    .form-section-heading {
        font-weight: 600;
        color: #343a40;
        margin-top: 2.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #e9ecef;
    }

    .form-floating .form-control {
        height: calc(3.5rem + 2px);
    }
    
    .custom-file-input {
        color: transparent;
    }
    .custom-file-input::-webkit-file-upload-button {
        visibility: hidden;
    }
    .custom-file-input::before {
        content: 'Choose New Image';
        color: #fff;
        background-color: #212529;
        display: inline-block;
        border: 1px solid transparent;
        border-radius: 0.375rem;
        padding: 0.75rem 1.25rem;
        outline: none;
        white-space: nowrap;
        cursor: pointer;
        font-weight: 600;
        transition: background-color .15s ease-in-out;
    }
    .custom-file-input:hover::before {
        background-color: #3e444a;
    }
    .custom-file-input:active::before {
        background-color: #4a5056;
    }
    #file-chosen {
        margin-left: 1rem;
        color: #6c757d;
        font-style: italic;
    }

    .current-image-preview {
        max-width: 200px;
        border-radius: 0.5rem;
        margin-top: 1rem;
    }

    .feature-card {
        border: 2px solid #e9ecef;
        border-radius: 0.75rem;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .feature-card:hover {
        border-color: #adb5bd;
        transform: translateY(-3px);
    }

    .feature-card.is-selected {
        border-color: #fe424d;
        background-color: #fff8f8;
        box-shadow: 0 4px 15px rgba(254, 66, 77, 0.1);
    }

    .feature-card .form-check-input {
        display: none; 
    }

    .feature-card i {
        font-size: 1.75rem;
        margin-bottom: 0.5rem;
        color: #495057;
    }
    
    .feature-card.is-selected i {
        color: #fe424d;
    }

    .feature-card span {
        font-weight: 500;
        color: #495057;
        font-size: 0.9rem;
    }

    .btn-brand-update {
        background-color: #fe424d;
        color: white;
        padding: 0.8rem;
        font-weight: 600;
        border-radius: 0.5rem;
    }
    .btn-brand-update:hover {
        background-color: #e03842;
        color: white;
    }

    /* --- RESPONSIVENESS --- */
    @media (max-width: 768px) {
        .host-form-container {
            padding: 2rem 1.5rem; /* Reduce padding on smaller screens */
        }

        .form-header h2 {
            font-size: 1.75rem; /* Slightly smaller heading on mobile */
        }
    }
</style>

<div class="row mt-4 mb-5 justify-content-center">
    <div class="col-11 col-md-9 col-lg-8">
        <div class="host-form-container">
            <div class="form-header text-center mb-4">
                <h2>Edit Your Listing</h2>
                <p>Make changes to your property details and save your updates.</p>
            </div>
            
            <form method="POST" action="/listings/<%= listing._id %>?_method=PUT" novalidate class="needs-validation" enctype="multipart/form-data">

                <h4 class="form-section-heading">Property Details</h4>
                <div class="form-floating my-3">
                    <input type="text" id="title" name="listing[title]" value="<%= listing.title %>" class="form-control" required>
                    <label for="title">Listing Title</label>
                    <div class="valid-feedback">Title looks good!</div>
                </div>
                <div class="form-floating mb-3">
                    <textarea id="description" name="listing[description]" class="form-control" required style="height: 120px"><%= listing.description %></textarea>
                    <label for="description">Description</label>
                    <div class="invalid-feedback">A detailed description is required.</div>
                </div>

                <h4 class="form-section-heading">Media</h4>
                <div class="my-3">
                    <label class="form-label">Current Image</label><br>
                    <img src="<%= originalImageUrl %>" alt="Current Listing Image" class="current-image-preview">
                </div>
                <div class="my-3">
                    <label for="image" class="form-label">Upload a new image to replace the current one.</label><br>
                    <input type="file" id="image" name="listing[image]" class="custom-file-input">
                    <span id="file-chosen">No new file chosen</span>
                </div>

                <h4 class="form-section-heading">Location & Price</h4>
                <div class="row">
                    <div class="col-md-8">
                        <div class="form-floating my-3">
                            <input type="text" id="location" name="listing[location]" value="<%= listing.location %>" class="form-control" required>
                            <label for="location">Location</label>
                            <div class="invalid-feedback">A valid location is required.</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-floating my-3">
                            <input type="text" id="country" name="listing[country]" value="<%= listing.country %>" class="form-control" required>
                            <label for="country">Country</label>
                            <div class="invalid-feedback">A country is required.</div>
                        </div>
                    </div>
                </div>
                <div class="form-floating mb-3">
                    <input type="number" id="price" name="listing[price]" value="<%= listing.price %>" class="form-control" required>
                    <label for="price">Price per night (in â‚¹)</label>
                    <div class="invalid-feedback">Please set a valid price.</div>
                </div>

                <% 
                const allFeatures = [
                    { name: 'Amazing Pools', value: 'amazing_pools', icon: 'fa-solid fa-person-swimming' }, { name: 'Iconic Cities', value: 'iconic_cities', icon: 'fa-solid fa-mountain-city' }, { name: 'Mountains', value: 'mountains', icon: 'fa-solid fa-mountain' }, { name: 'Beachfront', value: 'beachfront', icon: 'fa-solid fa-umbrella-beach' }, { name: 'Countryside', value: 'countryside', icon: 'fa-solid fa-seedling' }, { name: 'Arctic', value: 'arctic', icon: 'fa-solid fa-snowflake' }, { name: 'Private Rooms', value: 'private_rooms', icon: 'fa-solid fa-bed' }, { name: 'Castles', value: 'castles', icon: 'fa-solid fa-chess-rook' }, { name: 'Boats', value: 'boats', icon: 'fa-solid fa-ship' }, { name: 'Cabins', value: 'cabins', icon: 'fa-solid fa-house-chimney-window' }, { name: 'Farms', value: 'farms', icon: 'fa-solid fa-cow' }, { name: 'Tiny Homes', value: 'tiny_homes', icon: 'fa-solid fa-house-user' }, { name: 'Luxe', value: 'luxe', icon: 'fa-solid fa-gem' }, { name: 'Off-the-grid', value: 'off_the_grid', icon: 'fa-solid fa-tree' }
                ];
                %>
                <h4 class="form-section-heading">Features & Categories (Max 3)</h4>
                <p class="text-muted">Select all the features that apply to your property.</p>
                <div class="row g-3 my-2">
                    <% for(let feature of allFeatures) { %>
                    <div class="col-md-4 col-6">
                        <label class="feature-card" for="feature-<%= feature.value %>">
                            <input 
                                class="form-check-input" 
                                type="checkbox" 
                                name="listing[features][]"
                                value="<%= feature.value %>" 
                                id="feature-<%= feature.value %>"
                                <% if (listing.features && listing.features.includes(feature.value)) { %>checked<% } %>
                            >
                            <i class="<%= feature.icon %>"></i><br>
                            <span><%= feature.name %></span>
                        </label>
                    </div>
                    <% } %>
                </div>
                
                <div class="d-grid mt-4">
                    <button class="btn btn-brand-update mt-3">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // --- Script for custom file input ---
        const actualBtn = document.getElementById('image');
        const fileChosen = document.getElementById('file-chosen');
        actualBtn.addEventListener('change', function(){
            fileChosen.textContent = this.files[0] ? this.files[0].name : "No new file chosen";
        });

        // --- Script for selectable feature cards ---
        const featureCheckboxes = document.querySelectorAll('.feature-card .form-check-input');
        
        featureCheckboxes.forEach(checkbox => {
            const card = checkbox.closest('.feature-card');
            const updateCardStyle = () => {
                if (checkbox.checked) {
                    card.classList.add('is-selected');
                } else {
                    card.classList.remove('is-selected');
                }
            };
            updateCardStyle();
            checkbox.addEventListener('change', updateCardStyle);
        });

        // --- Script for limiting feature selection ---
        const maxFeatures = 3;
        const updateCheckboxState = () => {
            const checkedCount = document.querySelectorAll('.feature-card .form-check-input:checked').length;
            
            if (checkedCount >= maxFeatures) {
                featureCheckboxes.forEach(checkbox => {
                    if (!checkbox.checked) {
                        checkbox.disabled = true;
                        checkbox.closest('.feature-card').style.opacity = '0.5';
                        checkbox.closest('.feature-card').style.cursor = 'not-allowed';
                    }
                });
            } else {
                featureCheckboxes.forEach(checkbox => {
                    checkbox.disabled = false;
                    checkbox.closest('.feature-card').style.opacity = '1';
                    checkbox.closest('.feature-card').style.cursor = 'pointer';
                });
            }
        };
        featureCheckboxes.forEach(checkbox => checkbox.addEventListener('change', updateCheckboxState));
        updateCheckboxState(); // Initial check on page load
    });
</script>
